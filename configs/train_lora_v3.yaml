# LoRA fine-tuning v3 (MORE: same data as v2, stronger training)
# Same dataset as v2; multiple training improvements so the model learns the envelope.
# Prerequisites: same as v2 — split dataset_v2 → data/processed/splits/v2, prepare_sft_data → data/processed/sft/v2.

base_model_id: "meta-llama/Llama-2-7b-hf"

experiment:
  name: "v3"
  one_change: "v3: more epochs, max_seq_len 2048, warmup (same dataset v2)"
  one_change_key: "training.num_epochs"

data:
  train_path: data/processed/splits/v2/train.jsonl
  val_path: data/processed/splits/v2/val.jsonl
  train_sft_path: data/processed/sft/v2/train_sft.jsonl
  val_sft_path: data/processed/sft/v2/val_sft.jsonl
  max_seq_len: 2048   # full envelope in loss (v2 used 1024; truncation hurt schema compliance)

output:
  runs_dir: runs/train

training:
  seed: 42
  batch_size: 1
  grad_accum_steps: 8    # more optimizer steps per epoch (v2 had 16 → 10 steps/epoch)
  lr: 1.5e-4
  num_epochs: 3         # model sees data 3x (v2 had 1)
  max_grad_norm: 1.0
  warmup_steps: 10      # avoid full LR on step 1
  eval_every_steps: 100
  save_every_steps: 200

lora:
  r: 16
  alpha: 32
  dropout: 0.05
  target_modules: "auto"

runtime:
  device: auto
  precision: auto
  gradient_checkpointing: true
  dummy_model: false
  num_workers: 2
  pin_memory: true

logging:
  log_every_steps: 10
  enable_wandb: false
  project: pocketguide
